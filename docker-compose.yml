services:
  optimushq:
    build:
      context: .
      dockerfile: docker/platform/Dockerfile
    container_name: optimushq
    ports:
      - "3001:3001"
    group_add:
      - ${DOCKER_GID}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HOST_PROJECTS_DIR:-${HOME}/projects}:/projects
      - optimushq-data:/app/data
      - ${HOME}/.claude:/home/node/.claude
      - ${HOME}/.claude.json:/home/node/.claude.json:ro
      - ${HOME}/.gitconfig:/home/node/.gitconfig:ro
      - ${HOME}/.config/gh:/home/node/.config/gh:ro
    environment:
      - AUTH_USER=${AUTH_USER:-admin}
      - AUTH_PASS=${AUTH_PASS:-changeme}
      - PORT=3001
      - PROJECTS_ROOT=/projects
      # AGENT_MODE defaults to docker; set AGENT_MODE=local to disable containerized agents
      - AGENT_DEFAULT_IMAGE=claude-agent-base
      - DOCKER_GID=${DOCKER_GID}
      - HOST_PROJECTS_DIR=${HOST_PROJECTS_DIR:-${HOME}/projects}
      - HOST_CLAUDE_DIR=${HOME}/.claude
      - HOST_CLAUDE_JSON=${HOME}/.claude.json
      - HOST_GH_DIR=${HOME}/.config/gh
      - HOST_AWS_DIR=${HOME}/.aws
      - HOST_GITCONFIG=${HOME}/.gitconfig
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Fen}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-f.sev16@gmail.com}
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME:-Fen}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL:-f.sev16@gmail.com}
      - CHROME_HOST=chrome
      - CHROME_PORT=9222
      # Agent container security settings
      # AGENT_RUNTIME: set to "sysbox-runc" for isolated Docker-in-Docker per agent
      - AGENT_RUNTIME=${AGENT_RUNTIME:-}
      # AGENT_DOCKER_ACCESS: set to "socket" to mount host Docker socket into agents (less secure)
      - AGENT_DOCKER_ACCESS=${AGENT_DOCKER_ACCESS:-}
      # Resource limits for agent containers (override defaults)
      - AGENT_MEMORY_LIMIT=${AGENT_MEMORY_LIMIT:-}
      - AGENT_CPU_LIMIT=${AGENT_CPU_LIMIT:-}
      - AGENT_PIDS_LIMIT=${AGENT_PIDS_LIMIT:-}
    depends_on:
      - chrome
    restart: unless-stopped
    networks:
      - optimushq-net

  claude-agent-base:
    build:
      context: .
      dockerfile: docker/agent/base/Dockerfile
    image: claude-agent-base
    command: "true"

  # Specialized agent images â€” build with: docker compose --profile agent-images build
  claude-agent-node:
    build:
      context: .
      dockerfile: docker/agent/node/Dockerfile
    image: claude-agent-node
    command: "true"
    profiles:
      - agent-images

  claude-agent-python:
    build:
      context: .
      dockerfile: docker/agent/python/Dockerfile
    image: claude-agent-python
    command: "true"
    profiles:
      - agent-images

  claude-agent-browser:
    build:
      context: .
      dockerfile: docker/agent/browser/Dockerfile
    image: claude-agent-browser
    command: "true"
    profiles:
      - agent-images

  claude-agent-flutter:
    build:
      context: .
      dockerfile: docker/agent/flutter/Dockerfile
    image: claude-agent-flutter
    command: "true"
    profiles:
      - agent-images

  chrome:
    image: zenika/alpine-chrome:latest
    container_name: optimushq-chrome
    command: >
      --no-sandbox
      --disable-gpu
      --remote-debugging-address=0.0.0.0
      --remote-debugging-port=9222
      --disable-dev-shm-usage
    ports:
      - "9222:9222"
    restart: unless-stopped
    networks:
      - optimushq-net

volumes:
  optimushq-data:

networks:
  optimushq-net:
    name: optimushq-net
    driver: bridge
